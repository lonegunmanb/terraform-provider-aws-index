package github.com/hashicorp/terraform-provider-aws/internal/retry
import (
	"context"
	"errors"
	"time"

	"github.com/hashicorp/terraform-provider-aws/internal/backoff"
	inttypes "github.com/hashicorp/terraform-provider-aws/internal/types"
)
func (o operation[T]) Run(ctx context.Context, timeout time.Duration, opts ...backoff.Option) (T, error) {
	// We explicitly don't set a deadline on the context here to maintain compatibility
	// with the Plugin SDKv2 implementation. A parent context may have set a deadline.
	var l *backoff.Loop
	for l = backoff.NewLoopWithOptions(timeout, opts...); l.Continue(ctx); {
		t, err := o.op.Invoke(ctx)

		if retry, err := o.predicate.Invoke(t, err); !retry {
			return t, err
		}
	}

	var err error
	if l.Remaining() == 0 {
		err = inttypes.ErrDeadlineExceeded
	} else {
		err = context.Cause(ctx)
	}

	var zero T
	return zero, o.transformRunError(err)
}
