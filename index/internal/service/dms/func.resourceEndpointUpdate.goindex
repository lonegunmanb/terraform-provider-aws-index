package github.com/hashicorp/terraform-provider-aws/internal/service/dms
import (
	"context"
	"errors"
	"fmt"
	"log"
	"strings"
	"time"

	"github.com/YakDriver/regexache"
	"github.com/aws/aws-sdk-go-v2/aws"
	dms "github.com/aws/aws-sdk-go-v2/service/databasemigrationservice"
	awstypes "github.com/aws/aws-sdk-go-v2/service/databasemigrationservice/types"
	"github.com/hashicorp/go-cty/cty"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/customdiff"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/validation"
	"github.com/hashicorp/terraform-provider-aws/internal/conns"
	"github.com/hashicorp/terraform-provider-aws/internal/enum"
	"github.com/hashicorp/terraform-provider-aws/internal/errs"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/sdkdiag"
	"github.com/hashicorp/terraform-provider-aws/internal/retry"
	tfkms "github.com/hashicorp/terraform-provider-aws/internal/service/kms"
	tftags "github.com/hashicorp/terraform-provider-aws/internal/tags"
	"github.com/hashicorp/terraform-provider-aws/internal/tfresource"
	"github.com/hashicorp/terraform-provider-aws/internal/verify"
	"github.com/hashicorp/terraform-provider-aws/names"
)
func resourceEndpointUpdate(ctx context.Context, d *schema.ResourceData, meta any) diag.Diagnostics {
	var diags diag.Diagnostics
	conn := meta.(*conns.AWSClient).DMSClient(ctx)

	if d.HasChangesExcept(names.AttrTags, names.AttrTagsAll) {
		endpointARN := d.Get("endpoint_arn").(string)
		pauseTasks := d.Get("pause_replication_tasks").(bool)
		var tasks []awstypes.ReplicationTask

		if pauseTasks {
			var err error
			tasks, err = stopEndpointReplicationTasks(ctx, conn, endpointARN)

			if err != nil {
				return sdkdiag.AppendErrorf(diags, "stopping replication tasks before updating DMS Endpoint (%s): %s", d.Id(), err)
			}
		}

		if d.HasChangesExcept("pause_replication_tasks") {
			input := dms.ModifyEndpointInput{
				EndpointArn: aws.String(endpointARN),
				EngineName:  aws.String(d.Get("engine_name").(string)),
			}

			if d.HasChange(names.AttrCertificateARN) {
				input.CertificateArn = aws.String(d.Get(names.AttrCertificateARN).(string))
			}

			if d.HasChange(names.AttrEndpointType) {
				input.EndpointType = awstypes.ReplicationEndpointTypeValue(d.Get(names.AttrEndpointType).(string))
			}

			if d.HasChange("extra_connection_attributes") {
				input.ExtraConnectionAttributes = aws.String(d.Get("extra_connection_attributes").(string))
			}

			if d.HasChange("service_access_role") {
				input.DynamoDbSettings = &awstypes.DynamoDbSettings{
					ServiceAccessRoleArn: aws.String(d.Get("service_access_role").(string)),
				}
			}

			if d.HasChange("ssl_mode") {
				input.SslMode = awstypes.DmsSslModeValue(d.Get("ssl_mode").(string))
			}

			switch engineName := d.Get("engine_name").(string); engineName {
			case engineNameAurora, engineNameMariadb, engineNameMySQL:
				if d.HasChanges(
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort, names.AttrDatabaseName,
					"secrets_manager_access_role_arn", "secrets_manager_arn", "mysql_settings") {
					var settings *awstypes.MySQLSettings

					if v, ok := d.GetOk("mysql_settings"); ok && len(v.([]any)) > 0 && v.([]any)[0] != nil {
						settings = expandMySQLSettings(v.([]any)[0].(map[string]any))
					} else {
						settings = &awstypes.MySQLSettings{}
					}

					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						settings.SecretsManagerAccessRoleArn = aws.String(d.Get("secrets_manager_access_role_arn").(string))
						settings.SecretsManagerSecretId = aws.String(d.Get("secrets_manager_arn").(string))
					} else {
						settings.Username = aws.String(d.Get(names.AttrUsername).(string))
						settings.Password = aws.String(d.Get(names.AttrPassword).(string))
						settings.ServerName = aws.String(d.Get("server_name").(string))
						settings.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))

						// DatabaseName can be empty since it should not be specified
						// when mysql_settings.target_db_type is `multiple-databases`
						if v, ok := d.GetOk(names.AttrDatabaseName); ok {
							settings.DatabaseName = aws.String(v.(string))
						}

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}

					input.MySQLSettings = settings
				}
			case engineNameAuroraPostgresql, engineNamePostgres:
				if d.HasChanges(
					names.AttrDatabaseName, "postgres_settings",
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					var settings *awstypes.PostgreSQLSettings

					if v, ok := d.GetOk("postgres_settings"); ok && len(v.([]any)) > 0 && v.([]any)[0] != nil {
						settings = expandPostgreSQLSettings(v.([]any)[0].(map[string]any))
					} else {
						settings = &awstypes.PostgreSQLSettings{}
					}
					settings.DatabaseName = aws.String(d.Get(names.AttrDatabaseName).(string))

					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						settings.SecretsManagerAccessRoleArn = aws.String(d.Get("secrets_manager_access_role_arn").(string))
						settings.SecretsManagerSecretId = aws.String(d.Get("secrets_manager_arn").(string))
					} else {
						if v, ok := d.GetOk(names.AttrPassword); ok {
							settings.Password = aws.String(v.(string))
						}

						settings.Username = aws.String(d.Get(names.AttrUsername).(string))
						settings.ServerName = aws.String(d.Get("server_name").(string))
						settings.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}

					input.PostgreSQLSettings = settings
				}
			case engineNameDynamoDB:
				if d.HasChange("service_access_role") {
					input.DynamoDbSettings = &awstypes.DynamoDbSettings{
						ServiceAccessRoleArn: aws.String(d.Get("service_access_role").(string)),
					}
				}
			case engineNameElasticsearch, engineNameOpenSearch:
				if d.HasChanges(
					"elasticsearch_settings.0.service_access_role_arn",
					"elasticsearch_settings.0.endpoint_uri",
					"elasticsearch_settings.0.error_retry_duration",
					"elasticsearch_settings.0.full_load_error_percentage",
					"elasticsearch_settings.0.use_new_mapping_type") {
					input.ElasticsearchSettings = &awstypes.ElasticsearchSettings{
						ServiceAccessRoleArn:    aws.String(d.Get("elasticsearch_settings.0.service_access_role_arn").(string)),
						EndpointUri:             aws.String(d.Get("elasticsearch_settings.0.endpoint_uri").(string)),
						ErrorRetryDuration:      aws.Int32(int32(d.Get("elasticsearch_settings.0.error_retry_duration").(int))),
						FullLoadErrorPercentage: aws.Int32(int32(d.Get("elasticsearch_settings.0.full_load_error_percentage").(int))),
						UseNewMappingType:       aws.Bool(d.Get("elasticsearch_settings.0.use_new_mapping_type").(bool)),
					}
				}
			case engineNameKafka:
				if d.HasChange("kafka_settings") {
					input.KafkaSettings = expandKafkaSettings(d.Get("kafka_settings").([]any)[0].(map[string]any))
				}
			case engineNameKinesis:
				if d.HasChanges("kinesis_settings") {
					input.KinesisSettings = expandKinesisSettings(d.Get("kinesis_settings").([]any)[0].(map[string]any))
				}
			case engineNameMongodb:
				if d.HasChanges(
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort,
					names.AttrDatabaseName, names.AttrKMSKeyARN, "mongodb_settings.0.auth_type", "mongodb_settings.0.auth_mechanism", "mongodb_settings.0.nesting_level", "mongodb_settings.0.extract_doc_id", "mongodb_settings.0.docs_to_investigate", "mongodb_settings.0.auth_source",
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					var settings = &awstypes.MongoDbSettings{}

					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						settings.SecretsManagerAccessRoleArn = aws.String(d.Get("secrets_manager_access_role_arn").(string))
						settings.SecretsManagerSecretId = aws.String(d.Get("secrets_manager_arn").(string))
					} else {
						settings.Username = aws.String(d.Get(names.AttrUsername).(string))
						settings.Password = aws.String(d.Get(names.AttrPassword).(string))
						settings.ServerName = aws.String(d.Get("server_name").(string))
						settings.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}

					settings.DatabaseName = aws.String(d.Get(names.AttrDatabaseName).(string))
					settings.KmsKeyId = aws.String(d.Get(names.AttrKMSKeyARN).(string))
					settings.AuthType = awstypes.AuthTypeValue(d.Get("mongodb_settings.0.auth_type").(string))
					settings.AuthMechanism = awstypes.AuthMechanismValue(d.Get("mongodb_settings.0.auth_mechanism").(string))
					settings.NestingLevel = awstypes.NestingLevelValue(d.Get("mongodb_settings.0.nesting_level").(string))
					settings.ExtractDocId = aws.String(d.Get("mongodb_settings.0.extract_doc_id").(string))
					settings.DocsToInvestigate = aws.String(d.Get("mongodb_settings.0.docs_to_investigate").(string))
					settings.AuthSource = aws.String(d.Get("mongodb_settings.0.auth_source").(string))

					input.MongoDbSettings = settings
				}
			case engineNameOracle:
				if d.HasChanges(
					names.AttrDatabaseName, "oracle_settings",
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					var settings = &awstypes.OracleSettings{
						DatabaseName: aws.String(d.Get(names.AttrDatabaseName).(string)),
					}

					if v, ok := d.GetOk("oracle_settings"); ok && len(v.([]any)) > 0 && v.([]any)[0] != nil {
						settings.AuthenticationMethod = expandOracleSettings(v.([]any)).AuthenticationMethod
					}
					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						settings.SecretsManagerAccessRoleArn = aws.String(d.Get("secrets_manager_access_role_arn").(string))
						settings.SecretsManagerSecretId = aws.String(d.Get("secrets_manager_arn").(string))
					} else {
						if v, ok := d.GetOk(names.AttrPassword); ok {
							settings.Password = aws.String(v.(string))
						}

						settings.Username = aws.String(d.Get(names.AttrUsername).(string))
						settings.ServerName = aws.String(d.Get("server_name").(string))
						settings.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}

					input.OracleSettings = settings
				}
			case engineNameRedis:
				if d.HasChanges("redis_settings") {
					input.RedisSettings = expandRedisSettings(d.Get("redis_settings").([]any)[0].(map[string]any))
				}
			case engineNameRedshift:
				if d.HasChanges(
					names.AttrDatabaseName, "redshift_settings",
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					var settings = &awstypes.RedshiftSettings{
						DatabaseName: aws.String(d.Get(names.AttrDatabaseName).(string)),
					}

					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						settings.SecretsManagerAccessRoleArn = aws.String(d.Get("secrets_manager_access_role_arn").(string))
						settings.SecretsManagerSecretId = aws.String(d.Get("secrets_manager_arn").(string))
					} else {
						if v, ok := d.GetOk(names.AttrPassword); ok {
							settings.Password = aws.String(v.(string))
						}

						settings.Username = aws.String(d.Get(names.AttrUsername).(string))
						settings.ServerName = aws.String(d.Get("server_name").(string))
						settings.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}

					if v, ok := d.GetOk("redshift_settings"); ok && len(v.([]any)) > 0 && v.([]any)[0] != nil {
						tfMap := v.([]any)[0].(map[string]any)

						if v, ok := tfMap["bucket_folder"].(string); ok && v != "" {
							settings.BucketFolder = aws.String(v)
						}

						if v, ok := tfMap[names.AttrBucketName].(string); ok && v != "" {
							settings.BucketName = aws.String(v)
						}

						if v, ok := tfMap["encryption_mode"].(string); ok && v != "" {
							settings.EncryptionMode = awstypes.EncryptionModeValue(v)
						}

						if v, ok := tfMap["server_side_encryption_kms_key_id"].(string); ok && v != "" {
							settings.ServerSideEncryptionKmsKeyId = aws.String(v)
						}

						if v, ok := tfMap["service_access_role_arn"].(string); ok && v != "" {
							settings.ServiceAccessRoleArn = aws.String(v)
						}

						input.RedshiftSettings = settings
					}
				}
			case engineNameSQLServer, engineNameBabelfish:
				if d.HasChanges(
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort, names.AttrDatabaseName,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						input.MicrosoftSQLServerSettings = &awstypes.MicrosoftSQLServerSettings{
							DatabaseName:                aws.String(d.Get(names.AttrDatabaseName).(string)),
							SecretsManagerAccessRoleArn: aws.String(d.Get("secrets_manager_access_role_arn").(string)),
							SecretsManagerSecretId:      aws.String(d.Get("secrets_manager_arn").(string)),
						}
					} else {
						input.MicrosoftSQLServerSettings = &awstypes.MicrosoftSQLServerSettings{
							Username:     aws.String(d.Get(names.AttrUsername).(string)),
							Password:     aws.String(d.Get(names.AttrPassword).(string)),
							ServerName:   aws.String(d.Get("server_name").(string)),
							Port:         aws.Int32(int32(d.Get(names.AttrPort).(int))),
							DatabaseName: aws.String(d.Get(names.AttrDatabaseName).(string)),
						}

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}
				}
			case engineNameSybase:
				if d.HasChanges(
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort, names.AttrDatabaseName,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						input.SybaseSettings = &awstypes.SybaseSettings{
							DatabaseName:                aws.String(d.Get(names.AttrDatabaseName).(string)),
							SecretsManagerAccessRoleArn: aws.String(d.Get("secrets_manager_access_role_arn").(string)),
							SecretsManagerSecretId:      aws.String(d.Get("secrets_manager_arn").(string)),
						}
					} else {
						input.SybaseSettings = &awstypes.SybaseSettings{
							Username:     aws.String(d.Get(names.AttrUsername).(string)),
							Password:     aws.String(d.Get(names.AttrPassword).(string)),
							ServerName:   aws.String(d.Get("server_name").(string)),
							Port:         aws.Int32(int32(d.Get(names.AttrPort).(int))),
							DatabaseName: aws.String(d.Get(names.AttrDatabaseName).(string)),
						}

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}
				}
			case engineNameDB2, engineNameDB2zOS:
				if d.HasChanges(
					names.AttrUsername, names.AttrPassword, "server_name", names.AttrPort, names.AttrDatabaseName,
					"secrets_manager_access_role_arn", "secrets_manager_arn") {
					if _, ok := d.GetOk("secrets_manager_arn"); ok {
						input.IBMDb2Settings = &awstypes.IBMDb2Settings{
							DatabaseName:                aws.String(d.Get(names.AttrDatabaseName).(string)),
							SecretsManagerAccessRoleArn: aws.String(d.Get("secrets_manager_access_role_arn").(string)),
							SecretsManagerSecretId:      aws.String(d.Get("secrets_manager_arn").(string)),
						}
					} else {
						input.IBMDb2Settings = &awstypes.IBMDb2Settings{
							Username:     aws.String(d.Get(names.AttrUsername).(string)),
							Password:     aws.String(d.Get(names.AttrPassword).(string)),
							ServerName:   aws.String(d.Get("server_name").(string)),
							Port:         aws.Int32(int32(d.Get(names.AttrPort).(int))),
							DatabaseName: aws.String(d.Get(names.AttrDatabaseName).(string)),
						}

						// Update connection info in top-level namespace as well
						expandTopLevelConnectionInfoModify(d, &input)
					}
				}
			default:
				if d.HasChange(names.AttrDatabaseName) {
					input.DatabaseName = aws.String(d.Get(names.AttrDatabaseName).(string))
				}

				if d.HasChange(names.AttrPassword) {
					input.Password = aws.String(d.Get(names.AttrPassword).(string))
				}

				if d.HasChange(names.AttrPort) {
					input.Port = aws.Int32(int32(d.Get(names.AttrPort).(int)))
				}

				if d.HasChange("server_name") {
					input.ServerName = aws.String(d.Get("server_name").(string))
				}

				if d.HasChange(names.AttrUsername) {
					input.Username = aws.String(d.Get(names.AttrUsername).(string))
				}
			}

			_, err := conn.ModifyEndpoint(ctx, &input)

			if err != nil {
				return sdkdiag.AppendErrorf(diags, "updating DMS Endpoint (%s): %s", d.Id(), err)
			}
		}

		if pauseTasks && len(tasks) > 0 {
			if err := startEndpointReplicationTasks(ctx, conn, endpointARN, tasks); err != nil {
				return sdkdiag.AppendErrorf(diags, "starting replication tasks after updating DMS Endpoint (%s): %s", d.Id(), err)
			}
		}
	}

	return append(diags, resourceEndpointRead(ctx, d, meta)...)
}
