package github.com/hashicorp/terraform-provider-aws/internal/service/s3
import (
	"context"
	"fmt"
	"net/http"

	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/aws/arn"
	"github.com/aws/aws-sdk-go-v2/service/s3"
	awstypes "github.com/aws/aws-sdk-go-v2/service/s3/types"
	"github.com/hashicorp/aws-sdk-go-base/v2/endpoints"
	"github.com/hashicorp/aws-sdk-go-base/v2/tfawserr"
	"github.com/hashicorp/terraform-provider-aws/internal/conns"
	"github.com/hashicorp/terraform-provider-aws/internal/errs"
	tfs3control "github.com/hashicorp/terraform-provider-aws/internal/service/s3control"
	tftags "github.com/hashicorp/terraform-provider-aws/internal/tags"
	"github.com/hashicorp/terraform-provider-aws/internal/types/option"
)
func (p *servicePackage) ListTags(ctx context.Context, meta any, identifier, resourceType string) error {
	var (
		tags tftags.KeyValueTags
		err  error
	)
	c := meta.(*conns.AWSClient)
	conn := c.S3Client(ctx)

	switch resourceType {
	case "Bucket":
		if accountID := c.AccountID(ctx); accountID != "" {
			// Attempt ListTagsForResource first, fall back to GetBucketTagging.
			tags, err = tfs3control.ListTags(ctx, c.S3ControlClient(ctx), bucketARN(ctx, c, identifier), accountID)
			if errs.Contains(err, "is not authorized to perform: s3:ListTagsForResource") {
				tags, err = bucketListTags(ctx, conn, identifier)
			}
		} else {
			tags, err = bucketListTags(ctx, conn, identifier)
		}

	case "DirectoryBucket":
		tags, err = tfs3control.ListTags(ctx, c.S3ControlClient(ctx), identifier, c.AccountID(ctx))

	case "Object", "ObjectCopy", "BucketObject":
		var objectARN objectARN
		objectARN, err = parseObjectARN(identifier)
		if err != nil {
			return err
		}

		if isDirectoryBucket(objectARN.Bucket) {
			conn = meta.(*conns.AWSClient).S3ExpressClient(ctx)
		}

		var optFns []func(*s3.Options)
		// Via S3 access point: "Invalid configuration: region from ARN `us-east-1` does not match client region `aws-global` and UseArnRegion is `false`".
		if arn.IsARN(objectARN.Bucket) && conn.Options().Region == endpoints.AwsGlobalRegionID {
			optFns = append(optFns, func(o *s3.Options) { o.UseARNRegion = true })
		}

		tags, err = objectListTags(ctx, conn, objectARN.Bucket, objectARN.Key, optFns...)

	default:
		return nil
	}

	if err != nil {
		return err
	}

	if inContext, ok := tftags.FromContext(ctx); ok {
		inContext.TagsOut = option.Some(tags)
	}

	return nil
}
