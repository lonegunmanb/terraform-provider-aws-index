package github.com/hashicorp/terraform-provider-aws/internal/service/arcregionswitch
import (
	"context"
	"errors"
	"slices"
	"time"

	"github.com/YakDriver/smarterr"
	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/service/arcregionswitch"
	awstypes "github.com/aws/aws-sdk-go-v2/service/arcregionswitch/types"
	"github.com/hashicorp/terraform-plugin-framework-timeouts/resource/timeouts"
	"github.com/hashicorp/terraform-plugin-framework-validators/listvalidator"
	"github.com/hashicorp/terraform-plugin-framework-validators/stringvalidator"
	fwdiag "github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/resource"
	fwschema "github.com/hashicorp/terraform-plugin-framework/resource/schema"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/listplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/planmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/stringplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/schema/validator"
	"github.com/hashicorp/terraform-plugin-framework/types"
	"github.com/hashicorp/terraform-provider-aws/internal/errs"
	"github.com/hashicorp/terraform-provider-aws/internal/framework"
	"github.com/hashicorp/terraform-provider-aws/internal/framework/flex"
	fwtypes "github.com/hashicorp/terraform-provider-aws/internal/framework/types"
	fwvalidators "github.com/hashicorp/terraform-provider-aws/internal/framework/validators"
	"github.com/hashicorp/terraform-provider-aws/internal/retry"
	"github.com/hashicorp/terraform-provider-aws/internal/smerr"
	tftags "github.com/hashicorp/terraform-provider-aws/internal/tags"
	"github.com/hashicorp/terraform-provider-aws/internal/tfresource"
	"github.com/hashicorp/terraform-provider-aws/names"
)
func (m resourcePlanModel) expandParallelStepExecutionBlockConfig(ctx context.Context, pStep parallelStepModel, apiParallelStep *awstypes.Step, diags *fwdiag.Diagnostics) error {
	switch {
	case !pStep.ArcRoutingControlConfig.IsNull():
		pData, pD := pStep.ArcRoutingControlConfig.ToPtr(ctx)
		diags.Append(pD...)
		if diags.HasError() {
			return errors.New("failed to convert parallel arc routing control config")
		}

		var apiArcConfig awstypes.ArcRoutingControlConfiguration
		diags.Append(flex.Expand(ctx, pData.CrossAccountRole, &apiArcConfig.CrossAccountRole)...)
		diags.Append(flex.Expand(ctx, pData.ExternalID, &apiArcConfig.ExternalId)...)
		diags.Append(flex.Expand(ctx, pData.TimeoutMinutes, &apiArcConfig.TimeoutMinutes)...)

		if err := m.expandArcRegionAndRoutingControls(ctx, pData, &apiArcConfig, diags); err != nil {
			return err
		}

		apiParallelStep.ExecutionBlockConfiguration = &awstypes.ExecutionBlockConfigurationMemberArcRoutingControlConfig{
			Value: apiArcConfig,
		}
	case !pStep.ExecutionApprovalConfig.IsNull():
		pData, pD := pStep.ExecutionApprovalConfig.ToPtr(ctx)
		diags.Append(pD...)
		if diags.HasError() {
			return errors.New("failed to convert parallel execution approval config")
		}
		var pR awstypes.ExecutionBlockConfigurationMemberExecutionApprovalConfig
		diags.Append(flex.Expand(ctx, pData, &pR.Value)...)
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.CustomActionLambdaConfig.IsNull():
		pData, pD := pStep.CustomActionLambdaConfig.ToPtr(ctx)
		diags.Append(pD...)
		if diags.HasError() {
			return errors.New("failed to convert parallel custom action lambda config")
		}
		var pR awstypes.ExecutionBlockConfigurationMemberCustomActionLambdaConfig
		diags.Append(flex.Expand(ctx, pData, &pR.Value)...)
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.DocumentDbConfig.IsNull():
		pData, pD := pStep.DocumentDbConfig.ToPtr(ctx)
		diags.Append(pD...)
		if diags.HasError() {
			return errors.New("failed to convert parallel document db config")
		}
		var pR awstypes.ExecutionBlockConfigurationMemberDocumentDbConfig
		diags.Append(flex.Expand(ctx, pData, &pR.Value)...)
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.EC2ASGCapacityIncreaseConfig.IsNull():
		var pR awstypes.ExecutionBlockConfigurationMemberEc2AsgCapacityIncreaseConfig
		if err := expandSimpleConfig(ctx, pStep.EC2ASGCapacityIncreaseConfig, &pR.Value, diags); err != nil {
			return err
		}
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.ECSCapacityIncreaseConfig.IsNull():
		var pR awstypes.ExecutionBlockConfigurationMemberEcsCapacityIncreaseConfig
		if err := expandSimpleConfig(ctx, pStep.ECSCapacityIncreaseConfig, &pR.Value, diags); err != nil {
			return err
		}
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.EKSResourceScalingConfig.IsNull():
		pData, pD := pStep.EKSResourceScalingConfig.ToPtr(ctx)
		diags.Append(pD...)
		if diags.HasError() {
			return errors.New("failed to convert parallel EKS resource scaling config")
		}

		var apiEKSConfig awstypes.EksResourceScalingConfiguration
		diags.Append(flex.Expand(ctx, pData.CapacityMonitoringApproach, &apiEKSConfig.CapacityMonitoringApproach)...)
		diags.Append(flex.Expand(ctx, pData.EKSClusters, &apiEKSConfig.EksClusters)...)
		diags.Append(flex.Expand(ctx, pData.KubernetesResourceType, &apiEKSConfig.KubernetesResourceType)...)
		diags.Append(flex.Expand(ctx, pData.TargetPercent, &apiEKSConfig.TargetPercent)...)
		diags.Append(flex.Expand(ctx, pData.TimeoutMinutes, &apiEKSConfig.TimeoutMinutes)...)
		diags.Append(flex.Expand(ctx, pData.Ungraceful, &apiEKSConfig.Ungraceful)...)

		if err := m.expandEKSScalingResources(ctx, pData, &apiEKSConfig, diags); err != nil {
			return err
		}

		apiParallelStep.ExecutionBlockConfiguration = &awstypes.ExecutionBlockConfigurationMemberEksResourceScalingConfig{
			Value: apiEKSConfig,
		}
	case !pStep.GlobalAuroraConfig.IsNull():
		var pR awstypes.ExecutionBlockConfigurationMemberGlobalAuroraConfig
		if err := expandSimpleConfig(ctx, pStep.GlobalAuroraConfig, &pR.Value, diags); err != nil {
			return err
		}
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.RegionSwitchPlanConfig.IsNull():
		var pR awstypes.ExecutionBlockConfigurationMemberRegionSwitchPlanConfig
		if err := expandSimpleConfig(ctx, pStep.RegionSwitchPlanConfig, &pR.Value, diags); err != nil {
			return err
		}
		apiParallelStep.ExecutionBlockConfiguration = &pR
	case !pStep.Route53HealthCheckConfig.IsNull():
		var pR awstypes.ExecutionBlockConfigurationMemberRoute53HealthCheckConfig
		if err := expandSimpleConfig(ctx, pStep.Route53HealthCheckConfig, &pR.Value, diags); err != nil {
			return err
		}
		apiParallelStep.ExecutionBlockConfiguration = &pR
	}
	return nil
}
