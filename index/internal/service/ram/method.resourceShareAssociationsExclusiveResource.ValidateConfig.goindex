package github.com/hashicorp/terraform-provider-aws/internal/service/ram
import (
	"context"
	"fmt"

	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/service/ram"
	awstypes "github.com/aws/aws-sdk-go-v2/service/ram/types"
	"github.com/hashicorp/terraform-plugin-framework-validators/setvalidator"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/path"
	"github.com/hashicorp/terraform-plugin-framework/resource"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/planmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/stringplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/schema/validator"
	"github.com/hashicorp/terraform-plugin-framework/types"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/fwdiag"
	"github.com/hashicorp/terraform-provider-aws/internal/flex"
	"github.com/hashicorp/terraform-provider-aws/internal/framework"
	fwflex "github.com/hashicorp/terraform-provider-aws/internal/framework/flex"
	fwtypes "github.com/hashicorp/terraform-provider-aws/internal/framework/types"
	"github.com/hashicorp/terraform-provider-aws/internal/framework/validators"
	"github.com/hashicorp/terraform-provider-aws/internal/retry"
	inttypes "github.com/hashicorp/terraform-provider-aws/internal/types"
)
func (r *resourceShareAssociationsExclusiveResource) ValidateConfig(ctx context.Context, req resource.ValidateConfigRequest, resp *resource.ValidateConfigResponse) {
	var config resourceShareAssociationsExclusiveResourceModel
	resp.Diagnostics.Append(req.Config.Get(ctx, &config)...)
	if resp.Diagnostics.HasError() {
		return
	}

	// Skip validation if principals is null or unknown
	if config.Principals.IsNull() || config.Principals.IsUnknown() {
		// If sources is specified but principals is not, that's an error
		if !config.Sources.IsNull() && config.Sources.IsFullyKnown() {
			if sources := fwflex.ExpandFrameworkStringValueSet(ctx, config.Sources); len(sources) > 0 {
				resp.Diagnostics.AddAttributeError(
					path.Root("sources"),
					"Invalid Configuration",
					"sources can only be specified when principals contains only service principals (e.g., service-id.amazonaws.com)",
				)
			}
		}
		return
	}

	// Skip validation if any element in the set is unknown (e.g., references to other resources)
	if !config.Principals.IsFullyKnown() {
		return
	}

	principals := fwflex.ExpandFrameworkStringValueSet(ctx, config.Principals)

	// Count service principals and non-service principals
	var servicePrincipals, otherPrincipals []string
	for _, principal := range principals {
		if inttypes.IsServicePrincipal(principal) {
			servicePrincipals = append(servicePrincipals, principal)
		} else {
			otherPrincipals = append(otherPrincipals, principal)
		}
	}

	// Validate that service principals are not mixed with other principal types
	if len(servicePrincipals) > 0 && len(otherPrincipals) > 0 {
		resp.Diagnostics.AddAttributeError(
			path.Root("principals"),
			"Invalid Configuration",
			"Service principals (e.g., service-id.amazonaws.com) cannot be mixed with other principal types (AWS account IDs, organization ARNs, OU ARNs, IAM role ARNs, or IAM user ARNs)",
		)
		return
	}

	// Validate sources - only allowed when principals contains only service principals
	if !config.Sources.IsNull() && config.Sources.IsFullyKnown() {
		if sources := fwflex.ExpandFrameworkStringValueSet(ctx, config.Sources); len(sources) > 0 && len(servicePrincipals) == 0 {
			resp.Diagnostics.AddAttributeError(
				path.Root("sources"),
				"Invalid Configuration",
				"sources can only be specified when principals contains only service principals (e.g., service-id.amazonaws.com)",
			)
		}
	}
}
