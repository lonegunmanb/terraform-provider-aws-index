package github.com/hashicorp/terraform-provider-aws/internal/service/networkmanager
import (
	"context"
	"encoding/json"
	"fmt"
	"log"
	"strconv"

	"github.com/YakDriver/regexache"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/validation"
	"github.com/hashicorp/terraform-provider-aws/internal/create"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/sdkdiag"
	"github.com/hashicorp/terraform-provider-aws/internal/flex"
	"github.com/hashicorp/terraform-provider-aws/internal/verify"
	"github.com/hashicorp/terraform-provider-aws/names"
)
func dataSourceCoreNetworkPolicyDocumentRead(ctx context.Context, d *schema.ResourceData, meta any) diag.Diagnostics {
	var diags diag.Diagnostics

	mergedDoc := &coreNetworkPolicyDocument{
		Version: d.Get(names.AttrVersion).(string),
	}

	// CoreNetworkConfiguration
	networkConfiguration, err := expandCoreNetworkPolicyCoreNetworkConfiguration(d.Get("core_network_configuration").([]any))
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.CoreNetworkConfiguration = networkConfiguration

	// Segments
	segments, err := expandCoreNetworkPolicySegments(d.Get("segments").([]any))
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.Segments = segments

	// RoutingPolicies
	routingPolicies, err := expandCoreNetworkPolicyRoutingPolicies(d.Get("routing_policies").([]any), mergedDoc.Version)
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.RoutingPolicies = routingPolicies

	// NetworkFunctionGroups
	networkFunctionGroups, err := expandCoreNetworkPolicyNetworkFunctionGroups(d.Get("network_function_groups").([]any))
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.NetworkFunctionGroups = networkFunctionGroups

	// SegmentActions
	segment_actions, err := expandCoreNetworkPolicySegmentActions(d.Get("segment_actions").([]any))
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.SegmentActions = segment_actions

	// AttachmentPolicies
	attachmentPolicies, err := expandCoreNetworkPolicyAttachmentPolicies(d.Get("attachment_policies").([]any))
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.AttachmentPolicies = attachmentPolicies

	// AttachmentRoutingPolicyRules
	attachmentRoutingPolicyRules, err := expandCoreNetworkPolicyAttachmentRoutingPolicyRules(d.Get("attachment_routing_policy_rules").([]any), mergedDoc.Version)
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	mergedDoc.AttachmentRoutingPolicyRules = attachmentRoutingPolicyRules

	jsonDoc, err := json.MarshalIndent(mergedDoc, "", "  ")
	if err != nil {
		return sdkdiag.AppendFromErr(diags, err)
	}
	jsonString := string(jsonDoc)

	// Debug: Print the generated JSON policy document
	log.Printf("[DEBUG] Generated Core Network Policy Document JSON:\n%s", jsonString)

	d.Set(names.AttrJSON, jsonString)
	d.SetId(strconv.Itoa(create.StringHashcode(jsonString)))

	return diags
}
