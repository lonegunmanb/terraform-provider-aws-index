package github.com/hashicorp/terraform-provider-aws/internal/service/dynamodb
import (
	"context"
	"fmt"
	"os"
	"strings"
	"time"

	"github.com/aws/aws-sdk-go-v2/aws"
	"github.com/aws/aws-sdk-go-v2/service/dynamodb"
	awstypes "github.com/aws/aws-sdk-go-v2/service/dynamodb/types"
	"github.com/hashicorp/terraform-plugin-framework-timeouts/resource/timeouts"
	"github.com/hashicorp/terraform-plugin-framework-validators/helpers/validatordiag"
	"github.com/hashicorp/terraform-plugin-framework-validators/listvalidator"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/path"
	"github.com/hashicorp/terraform-plugin-framework/resource"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/listplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/planmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/setplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/resource/schema/stringplanmodifier"
	"github.com/hashicorp/terraform-plugin-framework/schema/validator"
	"github.com/hashicorp/terraform-plugin-framework/types"
	"github.com/hashicorp/terraform-plugin-log/tflog"
	"github.com/hashicorp/terraform-provider-aws/internal/errs"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/fwdiag"
	intflex "github.com/hashicorp/terraform-provider-aws/internal/flex"
	"github.com/hashicorp/terraform-provider-aws/internal/framework"
	fwflex "github.com/hashicorp/terraform-provider-aws/internal/framework/flex"
	fwtypes "github.com/hashicorp/terraform-provider-aws/internal/framework/types"
	"github.com/hashicorp/terraform-provider-aws/internal/retry"
	"github.com/hashicorp/terraform-provider-aws/internal/smerr"
	inttypes "github.com/hashicorp/terraform-provider-aws/internal/types"
	"github.com/hashicorp/terraform-provider-aws/names"
	semconv "go.opentelemetry.io/otel/semconv/v1.38.0"
)
func flattenGlobalSecondaryIndex(ctx context.Context, data *resourceGlobalSecondaryIndexModel, index *awstypes.GlobalSecondaryIndexDescription, table *awstypes.TableDescription) diag.Diagnostics { // nosemgrep:ci.semgrep.framework.manual-flattener-functions
	var diags diag.Diagnostics

	diags.Append(fwflex.Flatten(ctx, index, data,
		fwflex.WithFieldNamePrefix("Index"),
		fwflex.WithIgnoredFieldNamesAppend("KeySchema"),
		fwflex.WithIgnoredFieldNamesAppend("ProvisionedThroughput"),
	)...)

	data.TableName = fwflex.StringToFramework(ctx, table.TableName)

	attributeTypes := make(map[string]awstypes.ScalarAttributeType, len(table.AttributeDefinitions))
	for _, attribute := range table.AttributeDefinitions {
		attributeTypes[aws.ToString(attribute.AttributeName)] = attribute.AttributeType
	}

	keyModels := make([]keySchemaModel, len(index.KeySchema))
	for i, ks := range index.KeySchema {
		keyModels[i] = keySchemaModel{
			AttributeName: fwflex.StringToFramework(ctx, ks.AttributeName),
			AttributeType: fwtypes.StringEnumValue(attributeTypes[aws.ToString(ks.AttributeName)]),
			KeyType:       fwtypes.StringEnumValue(ks.KeyType),
		}
	}

	data.KeySchema = fwtypes.NewListNestedObjectValueOfValueSliceMust(ctx, keyModels)

	if index.ProvisionedThroughput != nil {
		var ptM provisionedThroughputModel
		d := fwflex.Flatten(ctx, index.ProvisionedThroughput, &ptM)
		diags.Append(d...)
		if diags.HasError() {
			return diags
		}
		if ptM.IsZero() {
			data.ProvisionedThroughput = fwtypes.NewListNestedObjectValueOfNull[provisionedThroughputModel](ctx)
		} else {
			data.ProvisionedThroughput = fwtypes.NewListNestedObjectValueOfValueSliceMust(ctx, []provisionedThroughputModel{ptM})
		}
	}

	return diags
}
