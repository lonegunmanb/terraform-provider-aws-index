package github.com/hashicorp/terraform-provider-aws/internal/framework/flex
import (
	"context"
	"fmt"
	"iter"
	"reflect"
	"strings"
	"sync"

	"github.com/hashicorp/terraform-plugin-framework-timetypes/timetypes"
	"github.com/hashicorp/terraform-plugin-framework/attr"
	"github.com/hashicorp/terraform-plugin-framework/diag"
	"github.com/hashicorp/terraform-plugin-framework/path"
	"github.com/hashicorp/terraform-plugin-framework/types/basetypes"
	"github.com/hashicorp/terraform-plugin-log/tflog"
	fwtypes "github.com/hashicorp/terraform-provider-aws/internal/framework/types"
	tfreflect "github.com/hashicorp/terraform-provider-aws/internal/reflect"
)
func (expander autoExpander) handleXMLWrapperCollapse(ctx context.Context, sourcePath path.Path, valFrom reflect.Value, targetPath path.Path, valTo reflect.Value, typeFrom, typeTo reflect.Type, processedFields map[string]bool) diag.Diagnostics {
	var diags diag.Diagnostics

	// Look for target fields that are complex XML wrapper structures
	for i := 0; i < typeTo.NumField(); i++ {
		toField := typeTo.Field(i)
		toFieldName := toField.Name
		toFieldType := toField.Type
		toFieldVal := valTo.Field(i)

		// Check if this is a pointer to a struct or direct struct
		var targetStructType reflect.Type
		if toFieldType.Kind() == reflect.Pointer && toFieldType.Elem().Kind() == reflect.Struct {
			targetStructType = toFieldType.Elem()
		} else if toFieldType.Kind() == reflect.Struct {
			targetStructType = toFieldType
		} else {
			continue
		}

		// Check if this target struct has the XML wrapper collapse pattern:
		// - Contains Items/Quantity fields (making it an XML wrapper)
		// - Contains additional fields that should come from other source fields
		if !expander.isXMLWrapperCollapseTarget(targetStructType) {
			continue
		}

		tflog.SubsystemTrace(ctx, subsystemName, "Found XML wrapper collapse target", map[string]any{
			logAttrKeyTargetFieldname: toFieldName,
			logAttrKeyTargetType:      targetStructType.String(),
		})

		// Handle XML wrapper collapse patterns generically
		diags.Append(expander.buildGenericXMLWrapperCollapse(ctx, sourcePath, valFrom, targetPath.AtName(toFieldName), toFieldVal, typeFrom, targetStructType, toFieldType.Kind() == reflect.Pointer, processedFields)...)
		if diags.HasError() {
			return diags
		}
	}

	return diags
}
