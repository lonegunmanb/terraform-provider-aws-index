package github.com/hashicorp/terraform-provider-aws/internal/provider/sdkv2
import (
	"context"
	"fmt"
	"slices"
	"unique"

	"github.com/hashicorp/terraform-plugin-log/tflog"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/sdkdiag"
	"github.com/hashicorp/terraform-provider-aws/internal/provider/interceptors"
	tftags "github.com/hashicorp/terraform-provider-aws/internal/tags"
	inttypes "github.com/hashicorp/terraform-provider-aws/internal/types"
	"github.com/hashicorp/terraform-provider-aws/internal/types/option"
	"github.com/hashicorp/terraform-provider-aws/names"
)
func validateRequiredTags() customizeDiffInterceptor {
	return interceptorFunc1[*schema.ResourceDiff, error](func(ctx context.Context, opts customizeDiffInterceptorOptions) error {
		c := opts.c

		_, _, _, typeName, _, ok := interceptors.InfoFromContext(ctx, c)
		if !ok {
			return nil
		}

		policy := c.TagPolicyConfig(ctx)
		if policy == nil {
			return nil
		}
		reqTags, ok := policy.RequiredTags[typeName]
		if !ok {
			return nil
		}

		switch d, when, why := opts.d, opts.when, opts.why; when {
		case Before:
			switch why {
			case CustomizeDiff:
				isCreate := d.GetRawState().IsNull()
				hasTagsChange := d.HasChange(names.AttrTags)

				if !isCreate && !hasTagsChange {
					return nil
				}

				if !d.GetRawPlan().GetAttr(names.AttrTags).IsWhollyKnown() {
					return nil
				}

				cfgTags := tftags.New(ctx, d.Get(names.AttrTags).(map[string]any))
				allTags := c.DefaultTagsConfig(ctx).MergeTags(cfgTags)
				if allTags.ContainsAllKeys(reqTags) {
					return nil
				}

				missing := reqTags.Removed(allTags).Keys()
				slices.Sort(missing)
				summary := "Missing Required Tags"
				detail := fmt.Sprintf("An organizational tag policy requires the following tags for %s: %s", typeName, missing)

				// CustomizeDiff does not support diagnostics (only an error return)
				switch policy.Severity {
				case "warning":
					// Warning diagnostics are only logged
					tflog.Warn(ctx, "Required Tags Validation", map[string]any{
						"summary": summary,
						"detail":  detail,
					})
				default:
					// Error diagnostics merge summary and detail into a single message
					return fmt.Errorf("%s - %s", summary, detail)
				}
			}
		}

		return nil
	})
}
