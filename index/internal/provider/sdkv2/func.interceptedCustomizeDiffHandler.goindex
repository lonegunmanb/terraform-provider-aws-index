package github.com/hashicorp/terraform-provider-aws/internal/provider/sdkv2
import (
	"context"
	"errors"

	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	"github.com/hashicorp/terraform-provider-aws/internal/conns"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/sdkdiag"
	"github.com/hashicorp/terraform-provider-aws/internal/sdkv2"
	tfslices "github.com/hashicorp/terraform-provider-aws/internal/slices"
)
func interceptedCustomizeDiffHandler(bootstrapContext contextFunc, interceptorInvocations interceptorInvocations, f schema.CustomizeDiffFunc) schema.CustomizeDiffFunc {
	// We run CustomizeDiff interceptors even if the resource has not defined a CustomizeDiff function.
	return func(ctx context.Context, d *schema.ResourceDiff, meta any) error {
		ctx, err := bootstrapContext(ctx, d.GetOk, meta)
		if err != nil {
			return err
		}

		why := CustomizeDiff

		// Before interceptors are run first to last.
		forward := make([]customizeDiffInterceptorInvocation, 0)
		for _, v := range interceptorInvocations.why(why) {
			if interceptor, ok := v.interceptor.(customizeDiffInterceptor); ok {
				forward = append(forward, customizeDiffInterceptorInvocation{
					when:        v.when,
					why:         v.why,
					interceptor: interceptor,
				})
			}
		}

		when := Before
		for _, v := range forward {
			if v.when&when != 0 {
				opts := customizeDiffInterceptorOptions{
					c:    meta.(*conns.AWSClient),
					d:    d,
					when: when,
					why:  why,
				}
				// Short circuit if any Before interceptor errors.
				if err := v.interceptor.run(ctx, opts); err != nil {
					return err
				}
			}
		}

		// All other interceptors are run last to first.
		reverse := tfslices.Reverse(forward)
		var errs []error

		when = After
		if f != nil {
			if err := f(ctx, d, meta); err != nil {
				when = OnError
				errs = append(errs, err)
			}
		}

		for _, v := range reverse {
			if v.when&when != 0 {
				opts := customizeDiffInterceptorOptions{
					c:    meta.(*conns.AWSClient),
					d:    d,
					when: when,
					why:  why,
				}
				if err := v.interceptor.run(ctx, opts); err != nil {
					errs = append(errs, err)
				}
			}
		}

		when = Finally
		for _, v := range reverse {
			if v.when&when != 0 {
				opts := customizeDiffInterceptorOptions{
					c:    meta.(*conns.AWSClient),
					d:    d,
					when: when,
					why:  why,
				}
				if err := v.interceptor.run(ctx, opts); err != nil {
					errs = append(errs, err)
				}
			}
		}

		return errors.Join(errs...)
	}
}
