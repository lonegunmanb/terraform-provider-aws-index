package github.com/hashicorp/terraform-provider-aws/internal/acctest
import (
	"bytes"
	"context"
	"crypto/tls"
	"encoding/xml"
	"fmt"
	"io"
	"math/rand" // nosemgrep: go.lang.security.audit.crypto.math_random.math-random-used -- Deterministic PRNG required for VCR test reproducibility
	"net/http"
	"os"
	"path/filepath"
	"reflect"
	"strconv"
	"strings"
	"testing"

	cleanhttp "github.com/hashicorp/go-cleanhttp"
	"github.com/hashicorp/terraform-plugin-go/tfprotov5"
	"github.com/hashicorp/terraform-plugin-log/tflog"
	"github.com/hashicorp/terraform-plugin-sdk/v2/diag"
	"github.com/hashicorp/terraform-plugin-sdk/v2/helper/schema"
	sdkacctest "github.com/hashicorp/terraform-plugin-testing/helper/acctest"
	"github.com/hashicorp/terraform-plugin-testing/helper/resource"
	"github.com/hashicorp/terraform-provider-aws/internal/conns"
	"github.com/hashicorp/terraform-provider-aws/internal/errs/sdkdiag"
	tfjson "github.com/hashicorp/terraform-provider-aws/internal/json"
	"github.com/hashicorp/terraform-provider-aws/internal/provider"
	"github.com/hashicorp/terraform-provider-aws/internal/vcr"
	"gopkg.in/dnaeon/go-vcr.v4/pkg/cassette"
	"gopkg.in/dnaeon/go-vcr.v4/pkg/recorder"
)
func closeVCRRecorder(ctx context.Context, t *testing.T) {
	t.Helper()
	testName := t.Name()

	// Don't close the recorder if we're running because of a panic.
	if p := recover(); p != nil {
		panic(p)
	}

	providerMetas.Lock()
	meta, ok := providerMetas[testName]
	providerMetas.Unlock()

	if ok {
		if !t.Failed() {
			if v, ok := meta.HTTPClient(ctx).Transport.(*recorder.Recorder); ok {
				t.Log("stopping VCR recorder")
				if err := v.Stop(); err != nil {
					t.Error(err)
				}
			}
		}

		providerMetas.Lock()
		delete(providerMetas, testName)
		providerMetas.Unlock()
	} else {
		t.Log("provider meta not found for test", testName)
	}

	// Save the randomness seed.
	randomnessSources.Lock()
	s, ok := randomnessSources[testName]
	randomnessSources.Unlock()

	if ok {
		if !t.Failed() {
			t.Log("persisting randomness seed")
			if err := writeSeedToFile(s.seed, vcrSeedFile(vcr.Path(), t.Name())); err != nil {
				t.Error(err)
			}
		}

		randomnessSources.Lock()
		delete(randomnessSources, testName)
		randomnessSources.Unlock()
	} else {
		t.Log("randomness source not found for test", testName)
	}
}
